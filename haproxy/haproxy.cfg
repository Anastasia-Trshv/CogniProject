global
    log stdout format raw local0
    maxconn 4096

defaults
    timeout connect 5s
    timeout client 50s
    timeout server 50s
    option redispatch
    option httplog
    log global

# -------------------------------
# FRONTEND ROUTING
# -------------------------------
frontend http_front
    bind *:80
    mode http

    # Redirect API calls to backend
    acl is_api path_beg /api/
    use_backend backend_servers if is_api

    # Redirect chat files (MinIO)
    acl is_chat_files path_beg /chat-files/
    use_backend minio_backend if is_chat_files

    # Everything else goes to frontend
    default_backend frontend_server

# -------------------------------
# BACKEND API SERVERS (Sticky, HTTP Mode)
# -------------------------------
backend backend_servers
    balance roundrobin
    mode http
    cookie SERVERID insert indirect nocache
    server backend_1 backend_1:8080 check cookie b1
    server backend_2 backend_2:8080 check cookie b2
    server backend_3 backend_3:8080 check cookie b3
    server backend_4 backend_4:8080 check cookie b4

# -------------------------------
# MINIO FILE STORAGE (HTTP Mode)
# -------------------------------
backend minio_backend
    balance roundrobin
    mode http
    server minio minio:9000 check

# -------------------------------
# FRONTEND (STATIC FILES)
# -------------------------------
backend frontend_server
    balance roundrobin
    mode http
    server frontend frontend:80 check
